# SOAR-0009: Type-safe streaming multipart support

Feature abstract â€“ a one sentence summary.

## Overview

- Proposal: SOAR-0009
- Author(s): [Honza Dvorsky](https://github.com/czechboy0)
- Status: **Awaiting Review**
- Issue: [apple/swift-openapi-generator#36](https://github.com/apple/swift-openapi-generator/issues/36)
- Implementation:
    - [apple/swift-openapi-runtime#69](https://github.com/apple/swift-openapi-runtime/pull/69)
    - [apple/swift-openapi-generator#366](https://github.com/apple/swift-openapi-generator/pull/366)
- Feature flag: `multipart`
- Affected components:
    - generator
    - runtime
- Links:
    - [OpenAPI 3.0.3 specification][openapi303]
    - [OpenAPI 3.1.0 specification][openapi310]
    - [Swagger.io documentation on multipart support in OpenAPI 3.x][swaggerio-multipart]
    - [RFC 7578: Returning Values from Forms: multipart/form-data][rfc7578]
    - [RFC 2046: Multipurpose Internet Mail Extensions (MIME) Part Two: Media Types][rfc2046]

### Introduction

Add support for multipart requests and responses by generating a type-safe representation of each part.

### Motivation

TODO - polish the runtime public names a bit more

TODO - explain the example use case that we'll use in this proposal, OpenAPI in the appendix. Explain early on the symmetry, so we talk about upload only, but works for download almost identically.

### Proposed solution

TODO: Describe your solution to the problem. Provide examples and describe how they work. Show how your solution is better than current workarounds.

TODO: This section should focus on what will change for the _adopters_ of Swift OpenAPI Generator.

### Detailed design

TODO: Describe the implementation of the feature, a link to a prototype implementation is encouraged here.

TODO: This section should focus on what will change for the _contributors_ to Swift OpenAPI Generator.

- TODO: Symmetry, client upload ~ server download (sending multipart), and client download ~ server upload (receiving multipart).
- TODO: Additional properties
    - unspecified ("undocumented" raw case)
    - true ("other") raw case
    - false (no extra case, validation sequence enforces the preconditionFailure is never hit)
    - true + type ("other" case, kind of like an array, but the name needs to be captured and surfaced)
- TODO: Boundary customization through configuration
- TODO: Access to the filename parameter in content-disposition
- TODO: Upload + optional request body = should be forbidden, fail in the generator as unsupported (skip + diagnostic), check with the scraper
- TODO: Encoding (custom headers)
- TODO: Encoding (explicitly specifying the content type, takes precedence over the default ones)
- TODO: Default content types based on schema type, from the OpenAPI specification.
- TODO: Arrays treated as multiple parts of the same name.
- TODO: Validation sequence - semantics enforced both when sending and receiving, both client and server.

### API stability

Discuss the API implications, making sure to considering all of:
- runtime public API
    - TODO: additive (non-breaking)
- runtime "Generated" SPI
    - TODO: breaking, a different type generated now, so behind a feature flag in 0.3.x

### Future directions

- TODO: A generated buffered representation with random access async properties (transparent buffering.)
- TODO: multipart/alternative, multipart/mixed, and other multipart subtypes.

### Alternatives considered

- TODO: Nothing: users compose and parse their own raw multipart requests/responses.
- TODO: Only surfacing the raw parts, no per-operation code generation.
- TODO: Not doing validation.
- TODO: Buffered representation (goes against 0.3.0, inverse layering.)

### Acknowledgements

A special thanks to [Si Beaumont](https://github.com/simonjbeaumont) for helping refine this proposal with thoughtful feedback.

[rfc7578]: https://www.rfc-editor.org/rfc/rfc7578
[rfc2046]: https://datatracker.ietf.org/doc/html/rfc2046
[rfc2046-section5.1]: https://datatracker.ietf.org/doc/html/rfc2046#section-5.1
[swaggerio-multipart]: https://swagger.io/docs/specification/describing-request-body/multipart-requests
[openapi303]: https://github.com/OAI/OpenAPI-Specification/blob/main/versions/3.0.3.md
[openapi310]: https://github.com/OAI/OpenAPI-Specification/blob/main/versions/3.1.0.md
[openapi303-multipart]: https://github.com/OAI/OpenAPI-Specification/blob/main/versions/3.0.3.md#special-considerations-for-multipart-content
[openapi310-multipart]: https://github.com/OAI/OpenAPI-Specification/blob/main/versions/3.1.0.md#special-considerations-for-multipart-content

### Appendix A: Example OpenAPI document with multipart bodies

```yaml
openapi: '3.1.0'
info:
  title: File storage service
  version: 1.0.0
paths:
  /files:
    put:
      operationId: uploadFile
      description: Uploads the provided file to the server.
      requestBody:
        required: true
        content:
          multipart/form-data:
            schema:
              type: object
              description: The components of the upload.
              properties:
                metadata:
                  $ref: '#/components/schemas/FileMetadata'
                  description: Extra information about the uploaded file.
                contents:
                  type: string
                  contentEncoding: binary
                  # Use format: binary in OpenAPI 3.0.x instead.
                  description: The raw contents of the file.
              required:
                - metadata
                - contents
      responses:
        '204':
          description: Successfully uploaded the file.
components:
  schemas:
    FileMetadata:
      type: object
      description: Extra information about a file.
      properties:
        createdBy:
          type: string
          description: The name of the user that created the file.
      required:
        - createdBy
```
